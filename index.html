<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KeyForge Errata Scanner</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="https://www.keyforgemastervault.com/favicon.ico">
  <meta name="theme-color" content="#111111">
  <style>
    :root { --bg: #111; --text: #eee; --accent: #0066cc; --errata: #ff4444; }
    * { box-sizing: border-box; }
    body { margin:0; padding:16px; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,sans-serif; }
    h1 { text-align:center; margin:0 0 8px; font-size:1.8em; }
    p { text-align:center; margin:8px 0 16px; color:#aaa; }
    #reader { width:100%; max-width:500px; margin:16px auto; height:300px; border-radius:12px; overflow:hidden; box-shadow:0 4px 20px rgba(0,0,0,0.5); background:#000; }
    button { width:100%; max-width:500px; margin:16px auto; display:block; padding:14px; font-size:18px; background:var(--accent); color:white; border:none; border-radius:12px; font-weight:600; }
    #deck { margin-top:24px; display:none; }
    .card { display:flex; align-items:center; padding:12px; border-bottom:1px solid #333; border-radius:8px; margin-bottom:8px; background:#1a1a1a; }
    .card img { width:60px; height:84px; margin-right:14px; border-radius:6px; object-fit:cover; }
    .card-title { font-weight:600; font-size:1.1em; }
    .card-house { font-size:0.85em; color:#999; margin-top:2px; }
    .errata { color:var(--errata); font-weight:bold; font-size:0.9em; margin-top:4px; }
    #status { text-align:center; color:#aaa; margin:10px 0; font-weight:600; }
    .legacy { color: #ffaa00; }
    a { color: var(--accent); }
  </style>
</head>
<body>
  <h1>KeyForge Errata Scanner</h1>
  <p>Point your camera at any deck QR code</p>
  <div id="status">Tap below to start</div>
  
  <div id="reader"></div>
  
  <button onclick="startScanner()">Start Scanner</button>

  <div id="deck">
    <h2 id="deck-name">Loading deck...</h2>
    <div id="cards"></div>
  </div>

  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <script>
    const deckDiv = document.getElementById('deck');
    const deckName = document.getElementById('deck-name');
    const cardsDiv = document.getElementById('cards');
    const status = document.getElementById('status');
    let html5QrCode;

    const API_KEY = '6ec5419d-5b71-4598-aca5-a8a78eb51c82';

    // ... ERRATA object same as before ...
    const ERRATA = {
      "Arcenomometer": "Enhance two. Action: During your opponent’s next turn, each time they play a card, they lose 1 Aember.",
      // ... (copy all from previous version)
      "Yzphyz Knowdrone": "Play: Archive a card. You may purge an archived card. If you do, stun a creature."
    };

    function startScanner() {
      status.textContent = 'Requesting camera...';
      html5QrCode = new Html5Qrcode("reader");

      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        (decodedText) => {
          const id = extractId(decodedText);  // FIXED: Now gets legacy OR UUID
          if (id) {
            stopScanner();
            loadDeck(id);
          }
        },
        () => {}
      ).then(() => {
        status.textContent = 'Scanning... (Green = detected)';
        document.querySelector('button').style.display = 'none';
      }).catch(err => {
        status.textContent = `Error: ${err}`;
      });
    }

    function stopScanner() {
      if (html5QrCode) html5QrCode.stop().then(() => html5QrCode.clear());
      document.querySelector('button').style.display = 'block';
      status.textContent = 'Tap to scan again';
    }

    // FIXED: Extract legacy deck ID OR UUID
    function extractId(text) {
      // Legacy: https://www.keyforgegame.com/deck/3RCVP-F833F-GVQ7P
      const legacyMatch = text.match(/keyforgegame\.com\/deck\/([A-Z0-9-]{15})/i);
      if (legacyMatch) return { type: 'legacy', id: legacyMatch[1], url: legacyMatch[0] };

      // New: deck-details/uuid OR raw UUID
      const uuidMatch = text.match(/([a-f0-9-]{36})/i);
      if (uuidMatch) return { type: 'uuid', id: uuidMatch[1], url: uuidMatch[0] };

      return null;
    }

    async function loadDeck(scanData) {
      deckDiv.style.display = 'block';
      deckName.textContent = 'Loading...';
      cardsDiv.innerHTML = '<p style="text-align:center;color:#aaa">Fetching deck...</p>';

      try {
        const res = await fetch(`https://decksofkeyforge.com/public-api/v3/decks/${scanData.id}`, {
          headers: { 'Api-Key': API_KEY }
        });
        const data = await res.json();

        if (data.deck) {
          // SUCCESS: Render deck
          deckName.textContent = data.deck.name || 'Unknown Deck';
          cardsDiv.innerHTML = '';
          data._linked.cards.forEach(card => {
            const div = document.createElement('div');
            div.className = 'card';
            const hasErrata = ERRATA[card.title];
            div.innerHTML = `
              <img src="${card.image_url}" alt="${card.title}" loading="lazy">
              <div>
                <div class="card-title">${card.title}</div>
                <div class="card-house">${card.house}</div>
                ${hasErrata ? '<div class="errata">ERRATA → Tap to view</div>' : ''}
              </div>
            `;
            if (hasErrata) {
              div.style.cursor = 'pointer';
              div.onclick = () => showErrata(card.title);
            }
            cardsDiv.appendChild(div);
          });
        } else {
          // NOT FOUND: Show import instructions
          throw new Error(scanData.type === 'legacy' ? 'legacy' : 'notfound');
        }

      } catch (e) {
        deckName.textContent = scanData.type === 'legacy' ? 'Legacy Deck' : 'Deck Not Found';
        cardsDiv.innerHTML = `
          <p style="color:${scanData.type === 'legacy' ? '#ffaa00' : '#f88'}; text-align:center;">
            ${scanData.type === 'legacy' ? 
              `Legacy deck detected!<br><br><strong>Import to DoK:</strong><br>
               1. <a href="https://www.keyforgegame.com/deck/${scanData.id}" target="_blank">Open in Master Vault</a><br>
               2. Share → "Open in DoK"<br>
               3. Rescan!` : 
              `Not in DoK yet.<br><br><strong>Import:</strong><br>
               1. Open in Master Vault app<br>
               2. Share → "Open in DoK"<br>
               3. Rescan!`
            }
          </p>
        `;
      }
    }

    function showErrata(title) {
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;padding:20px;z-index:9999;';
      modal.innerHTML = `
        <div style="background:#300;padding:20px;border-radius:8px;max-width:500px;color:#eee;">
          <h3 style="margin-top:0;">${title} (Errata)</h3>
          <p>${ERRATA[title]}</p>
          <button onclick="this.closest('div').remove()" style="margin-top:16px;padding:10px 20px;background:#c00;color:white;border:none;border-radius:8px;">Close</button>
        </div>
      `;
      document.body.appendChild(modal);
    }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(() => {});
    }
  </script>
</body>
</html>
