<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KF Errata Scanner</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="https://www.keyforgemastervault.com/favicon.ico">
  <meta name="theme-color" content="#111111">
  <style>
    :root { --bg: #111; --text: #eee; --accent: #0066cc; --errata: #ff4444; --green: #0f0; }
    * { box-sizing: border-box; }
    body { margin:0; padding:16px; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,sans-serif; }
    h1 { text-align:center; margin:0 0 8px; font-size:1.8em; }
    p { text-align:center; margin:8px 0 16px; color:#aaa; }
    #reader { width:100%; max-width:500px; margin:16px auto; height:300px; border-radius:12px; overflow:hidden; box-shadow:0 4px 20px rgba(0,0,0,0.5); background:#000; border: 3px solid transparent; }
    #reader.scanning { border-color: var(--green); }
    button { width:100%; max-width:500px; margin:16px auto; display:block; padding:14px; font-size:18px; background:var(--accent); color:white; border:none; border-radius:12px; font-weight:600; }
    #deck { margin-top:24px; display:none; }
    .card { display:flex; align-items:center; padding:12px; border-bottom:1px solid #333; border-radius:8px; margin-bottom:8px; background:#1a1a1a; }
    .card img { width:60px; height:84px; margin-right:14px; border-radius:6px; object-fit:cover; }
    .card-title { font-weight:600; font-size:1.1em; }
    .card-house { font-size:0.85em; color:#999; margin-top:2px; }
    .errata { color:var(--errata); font-weight:bold; font-size:0.9em; margin-top:4px; }
    .errata-text { background:#300; padding:12px; border-radius:8px; margin:12px 0; font-size:0.95em; line-height:1.5; }
    #status { text-align:center; color:#aaa; margin:10px 0; font-weight:600; }
    #debug { background:#222; padding:10px; border-radius:8px; font-family:monospace; font-size:0.8em; color:#0f0; margin:10px 0; display:none; }
  </style>
</head>
<body>
  <h1>KeyForge Errata Scanner</h1>
  <p>Point at deck QR code</p>
  <div id="status">Ready</div>
  <div id="debug"></div>
  
  <div id="reader"></div>
  
  <button onclick="startScanner()">Start Scanner</button>

  <div id="deck">
    <h2 id="deck-name">Loading...</h2>
    <div id="cards"></div>
  </div>

  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <script>
    const deckDiv = document.getElementById('deck');
    const deckName = document.getElementById('deck-name');
    const cardsDiv = document.getElementById('cards');
    const status = document.getElementById('status');
    const debug = document.getElementById('debug');
    const reader = document.getElementById('reader');
    let html5QrCode;

    const API_KEY = '6ec5419d-5b71-4598-aca5-a8a78eb51c82';

    const ERRATA = { /* ... same as before ... */ };

    function log(msg) {
      debug.style.display = 'block';
      debug.textContent = msg;
      console.log('[KF Scanner]', msg);
    }

    function startScanner() {
      status.textContent = 'Starting camera...';
      log('Camera requested');
      
      html5QrCode = new Html5Qrcode("reader");
      
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        (decodedText) => {
          log(`QR detected: ${decodedText}`);
          reader.classList.add('scanning');
          
          const uuid = extractUuid(decodedText);
          if (uuid) {
            log(`UUID found: ${uuid}`);
            stopScanner();
            loadDeck(uuid);
          } else {
            log(`No UUID in: ${decodedText}`);
          }
        },
        () => {}
      ).then(() => {
        status.textContent = 'Scanning...';
        reader.classList.add('scanning');
        document.querySelector('button').style.display = 'none';
      }).catch(err => {
        status.textContent = 'Camera failed';
        log(`Error: ${err}`);
      });
    }

    function stopScanner() {
      if (html5QrCode) {
        html5QrCode.stop().then(() => {
          html5QrCode.clear();
          reader.classList.remove('scanning');
        });
      }
      document.querySelector('button').style.display = 'block';
      status.textContent = 'Tap to scan again';
    }

    function extractUuid(text) {
      // Match ANY 36-char UUID in the string
      const match = text.match(/[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}/i);
      if (match) return match[0];

      // Fallback: try to get last part of URL
      try {
        const url = new URL(text);
        const parts = url.pathname.split('/');
        const last = parts[parts.length - 1];
        if (last.length === 36 && last.includes('-')) return last;
      } catch {}

      return null;
    }

    async function loadDeck(uuid) {
      deckDiv.style.display = 'block';
      deckName.textContent = 'Loading...';
      cardsDiv.innerHTML = '<p style="text-align:center;color:#aaa">Fetching from DoK...</p>';

      try {
        const res = await fetch(`https://decksofkeyforge.com/public-api/v3/decks/${uuid}`, {
          headers: { 'Api-Key': API_KEY }
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        if (!data.deck) throw new Error("No deck data");

        deckName.textContent = data.deck.name || 'Unknown Deck';
        cardsDiv.innerHTML = '';

        data._linked.cards.forEach(card => {
          const div = document.createElement('div');
          div.className = 'card';
          const hasErrata = ERRATA[card.title];
          div.innerHTML = `
            <img src="${card.image_url}" alt="${card.title}" loading="lazy">
            <div>
              <div class="card-title">${card.title}</div>
              <div class="card-house">${card.house}</div>
              ${hasErrata ? '<div class="errata">ERRATA → Tap to view</div>' : ''}
            </div>
          `;
          if (hasErrata) {
            div.style.cursor = 'pointer';
            div.onclick = () => showErrata(card.title);
          }
          cardsDiv.appendChild(div);
        });

      } catch (e) {
        deckName.textContent = 'Not in DoK';
        cardsDiv.innerHTML = '<p style="color:#f88;text-align:center">Open in Master Vault → Share → "Open in DoK"</p>';
        log(`Load failed: ${e.message}`);
      }
    }

    function showErrata(title) {
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;padding:20px;z-index:9999;';
      modal.innerHTML = `
        <div class="errata-text" style="max-width:500px;">
          <h3 style="margin-top:0;">${title} (Errata)</h3>
          <p>${ERRATA[title]}</p>
          <button onclick="this.closest('div').remove()" style="margin-top:16px;padding:10px 20px;background:#c00;color:white;border:none;border-radius:8px;">Close</button>
        </div>
      `;
      document.body.appendChild(modal);
    }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(() => {});
    }
  </script>
</body>
</html>
