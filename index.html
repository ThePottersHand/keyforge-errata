<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Keyforge Deck Selector</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="data:,">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
:root{
  --bg:#121212; --card:#1e1e1e; --text:#e0e0e0;
  --primary:#d32f2f; --success:#4caf50;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:Arial,sans-serif;background:var(--bg);color:var(--text);padding:15px;line-height:1.6;font-size:16px;}
.container{max-width:1100px;margin:auto;}
h1{color:#ffeb3b;text-align:center;margin:20px 0;font-size:2rem;}
.controls{background:var(--card);padding:18px;border-radius:12px;margin-bottom:20px;box-shadow:0 4px 12px rgba(0,0,0,.4);}
/* COLLAPSIBLE */
.collapsible-header{
  display:flex;justify-content:space-between;align-items:center;
  cursor:pointer;padding:12px 0;font-weight:bold;font-size:1.1rem;
}
.collapsible-header::after{content:'expand_less';font-family:'Material Icons';font-size:1.4rem;color:#aaa;}
.collapsed .collapsible-header::after{content:'expand_more';}
.collapsible-content{max-height:1500px;transition:max-height .3s ease;overflow:hidden;}
.collapsed .collapsible-content{max-height:0;padding:0;}
/* MODE TOGGLE */
.mode-toggle{display:flex;gap:15px;margin-bottom:15px;flex-wrap:wrap;}
.mode-toggle label input{margin-right:6px;}
label{display:block;margin:12px 0 6px;font-weight:bold;}
select,input,button{width:100%;padding:12px;margin:6px 0;border:none;border-radius:8px;font-size:16px;}
input[type="number"]{width:100%;font-size:16px;}
select[multiple]{height:130px;background:#2a2a2a;color:white;font-size:15px;}
button{background:var(--primary);color:white;font-weight:bold;cursor:pointer;transition:.3s;}
button:hover{background:#b71c1c;}
.btn-small{display:inline-block;width:auto;padding:6px 12px;margin:4px 2px;font-size:14px;}
.btn-success{background:var(--success);}
.btn-success:hover{background:#388e3c;}
/* FILTER GRID */
.filter-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;}
/* DECK */
.deck{background:var(--card);padding:18px;border-radius:12px;margin:20px 0;box-shadow:0 4px 12px rgba(0,0,0,.4);}
.house{margin:25px 0 10px;text-align:center;}
.house img{width:70px;height:70px;border-radius:50%;background:#333;padding:5px;}
.house h3{display:inline-block;margin-left:10px;vertical-align:middle;font-size:1.3rem;color:#ffeb3b;}
.house-cards{display:flex;flex-direction:column;gap:8px;margin-top:12px;}
.card{background:#2a2a2a;padding:10px 12px;border-radius:6px;font-size:0.95rem;}
.errata{color:#ff5252;font-weight:bold;}
.links a{color:#90caf9;text-decoration:none;margin-right:15px;font-size:0.9rem;}
.links a:hover{text-decoration:underline;}
.loading{color:#ffeb3b;font-style:italic;text-align:center;margin-bottom:15px;}
.help{font-size:.85em;color:#aaa;margin-top:4px;}
.manual-deck-list{max-height:200px;overflow-y:auto;background:#2a2a2a;padding:10px;border-radius:8px;margin-top:10px;font-size:15px;}
/* RESPONSIVE */
@media(max-width:800px){.filter-grid{grid-template-columns:1fr;}}
</style>
</head>
<body>
<div class="container">
  <h1>Keyforge Deck Selector</h1>

  <div class="controls">
    <p class="loading" id="loading">Loading decks from CSV…</p>

    <div class="mode-toggle">
      <label><input type="radio" name="mode" value="random" checked> Random</label>
      <label><input type="radio" name="mode" value="manual"> Manual</label>
    </div>

    <div id="randomMode">
      <div class="collapsible-header" onclick="toggleCollapse(this)">Filters</div>
      <div class="collapsible-content">
        <label>Number of Decks:</label>
        <select id="numDecks">
          <option value="1">1 Deck</option>
          <option value="2">2 Decks</option>
        </select>

        <label>SAS Range:</label>
        <div style="display:flex;gap:10px;align-items:center;">
          <input type="number" id="sasMinInput" placeholder="Min" style="flex:1">
          <span style="width:20px;text-align:center;">–</span>
          <input type="number" id="sasMaxInput" placeholder="Max" style="flex:1">
        </div>
        <div class="help">Leave blank for full range</div>

        <div id="diffControl" style="display:none;margin-top:10px;">
          <label>Max SAS Difference:</label>
          <input type="number" id="maxDiffInput" min="0" max="30" value="5">
        </div>

        <div class="filter-grid">
          <div>
            <label>Sets:</label>
            <div style="display:flex;gap:5px;">
              <button class="btn-small btn-success" onclick="selectAll('sets')">All</button>
              <button class="btn-small" onclick="clearAll('sets')">Clear</button>
            </div>
            <select id="sets" multiple></select>
          </div>
          <div>
            <label>Houses:</label>
            <div style="display:flex;gap:5px;">
              <button class="btn-small btn-success" onclick="selectAll('houses')">All</button>
              <button class="btn-small" onclick="clearAll('houses')">Clear</button>
            </div>
            <select id="houses" multiple></select>
          </div>
        </div>

        <button id="selectBtn" disabled style="margin-top:20px;" onclick="pickDecks()">
          Select Random Deck(s)
        </button>
      </div>
    </div>

    <div id="manualMode" style="display:none;">
      <label>Select Deck:</label>
      <select id="manualDeckList" size="10" class="manual-deck-list"></select>
      <button id="showManualBtn" disabled style="margin-top:10px;" onclick="showManualDeck()">Show Deck</button>
    </div>
  </div>

  <div id="results"></div>
</div>

<script>
function toggleCollapse(header){
  const content = header.nextElementSibling;
  const parent = header.parentElement;
  parent.classList.toggle('collapsed');
}

const ERRATA = { /* ... same as before ... */ };

let data = [], sets = new Set(), houses = new Set();
let minSAS = Infinity, maxSAS = -Infinity;

function parseCSV(text){
  const rows = [];
  let cur = '', inQ = false, field = '';
  for(let i=0;i<text.length;i++){
    const ch = text[i], next = text[i+1];
    if(ch==='"' && text[i-1]!=='\\'){
      if(inQ && next==='"'){ field+='"'; i++; }
      else inQ = !inQ;
    }else if(ch===',' && !inQ){
      cur += field.trim() + '|';
      field = '';
    }else if(ch==='\n' && !inQ){
      cur += field.trim();
      rows.push(cur);
      cur = ''; field = '';
    }else field += ch;
  }
  if(field) cur += field.trim();
  if(cur) rows.push(cur);
  return rows;
}

fetch('decks_data_fixed.csv')
  .then(r=>r.text())
  .then(text=>{
    const rows = parseCSV(text).slice(1);
    data = rows.map(r=>{
      const c = r.split('|');
      const uuid = c[0].trim();
      const name = c[1].replace(/^"|"$/g,'').replace(/""/g,'"').trim();
      const set  = c[2].trim();
      const housesStr = c[3].trim();
      const sas = parseInt(c[4]);
      const cardsStr = c[8].trim();

      const houseList = housesStr.split(',').map(h=>h.trim().toLowerCase());
      houseList.forEach(h=>houses.add(h));
      sets.add(set);

      minSAS = Math.min(minSAS, sas);
      maxSAS = Math.max(maxSAS, sas);

      let cards = {};
      try{
        let s = cardsStr.replace(/^"|"$/g, '').trim();
        s = s.replace(/\\"/g, '"');
        s = s.replace(/""([^""]+)""(?=:|\s*\[)/g, '"$1"');
        if(s.startsWith('{') && s.endsWith('}')){
          cards = JSON.parse(s);
        }else{
          const re = /"([^"]+)":\s*\[([^\]]*)\]/g;
          let m;
          while((m=re.exec(s))!==null){
            const h = m[1].trim();
            const list = m[2].replace(/"/g,'').split(',').map(x=>x.trim()).filter(x=>x);
            cards[h] = list;
            houses.add(h.toLowerCase());
          }
        }
      }catch(e){
        console.warn('Card parse failed for', name, e);
        cards = {"ERROR":["Parse failed"]};
      }

      return {uuid,name,set,housesStr,houseList,sas,cards};
    });

    document.getElementById('loading').textContent = `Loaded ${data.length} decks.`;
    document.getElementById('selectBtn').disabled = false;
    document.getElementById('showManualBtn').disabled = false;

    document.getElementById('sasMinInput').placeholder = minSAS;
    document.getElementById('sasMaxInput').placeholder = maxSAS;

    fillFilters();
    fillManualList();
  })
  .catch(err=>{
    console.error(err);
    document.getElementById('loading').innerHTML = `<span style="color:#ff5252">Failed to load CSV. Use local server.</span>`;
  });

function fillFilters(){
  const setSel = document.getElementById('sets');
  const houseSel = document.getElementById('houses');
  setSel.innerHTML = houseSel.innerHTML = '';

  [...sets].sort().forEach(s=>{
    const o=document.createElement('option');
    o.value=s; o.textContent=s;
    setSel.appendChild(o);
  });
  [...houses].sort().forEach(h=>{
    const o=document.createElement('option');
    o.value=h; o.textContent=h.charAt(0).toUpperCase()+h.slice(1);
    houseSel.appendChild(o);
  });
}

function fillManualList(){
  const list = document.getElementById('manualDeckList');
  list.innerHTML = '';
  const sorted = [...data].sort((a,b)=>a.name.localeCompare(b.name));
  sorted.forEach(d=>{
    const opt = document.createElement('option');
    opt.value = d.uuid;
    opt.textContent = `${d.name} (SAS: ${d.sas})`;
    list.appendChild(opt);
  });
}

document.querySelectorAll('input[name="mode"]').forEach(r=>{
  r.addEventListener('change',()=>{
    const mode = r.value;
    document.getElementById('randomMode').style.display = mode==='random'?'block':'none';
    document.getElementById('manualMode').style.display = mode==='manual'?'block':'none';
  });
});

function selectAll(id){ const s=document.getElementById(id); for(let o of s.options) o.selected=true; }
function clearAll(id){ const s=document.getElementById(id); for(let o of s.options) o.selected=false; }

document.getElementById('numDecks').addEventListener('change',()=>{
  document.getElementById('diffControl').style.display = 
    document.getElementById('numDecks').value==='2' ? 'block':'none';
});

function pickDecks(){
  const num = +document.getElementById('numDecks').value;
  const minInput = document.getElementById('sasMinInput').value;
  const maxInput = document.getElementById('sasMaxInput').value;
  const min = minInput ? +minInput : minSAS;
  const max = maxInput ? +maxInput : maxSAS;
  const selSets = Array.from(document.getElementById('sets').selectedOptions).map(o=>o.value);
  const selHouses = Array.from(document.getElementById('houses').selectedOptions).map(o=>o.value.toLowerCase());
  const diff = num===2 ? +document.getElementById('maxDiffInput').value : 0;

  let pool = data.filter(d=>
    d.sas>=min && d.sas<=max &&
    (selSets.length===0 || selSets.includes(d.set)) &&
    (selHouses.length===0 || selHouses.every(h=>d.houseList.includes(h)))
  );

  if(pool.length<num){
    document.getElementById('results').innerHTML = `<p style="color:#ff5252;text-align:center;">Not enough decks (found ${pool.length}, need ${num})</p>`;
    return;
  }

  let chosen = [];
  if(num===1){
    chosen = [pool[Math.floor(Math.random()*pool.length)]];
  }else{
    let tries=0;
    while(tries<2000){
      const a=pool[Math.floor(Math.random()*pool.length)];
      const b=pool[Math.floor(Math.random()*pool.length)];
      if(a.uuid!==b.uuid && Math.abs(a.sas-b.sas)<=diff){
        chosen=[a,b];
        break;
      }
      tries++;
    }
    if(chosen.length===0){
      document.getElementById('results').innerHTML = `<p style="color:#ff5252">Could not find 2 decks within SAS diff ${diff}</p>`;
      return;
    }
  }
  renderDecks(chosen);
}

function showManualDeck(){
  const uuid = document.getElementById('manualDeckList').value;
  const deck = data.find(d=>d.uuid===uuid);
  if(deck) renderDecks([deck]);
}

function renderDecks(decks){
  const out=document.getElementById('results');
  out.innerHTML='';

  decks.forEach((d,i)=>{
    const div=document.createElement('div');
    div.className='deck';
    div.innerHTML=`
      <h2>${d.name}</h2>
      <p><strong>Set:</strong> ${d.set} | <strong>SAS:</strong> ${d.sas} | <strong>Houses:</strong> ${d.housesStr}</p>
      <div class="links">
        <a href="https://decksofkeyforge.com/decks/${d.uuid}" target="_blank">Decks of Keyforge</a>
        <a href="https://www.keyforgegame.com/deck-details/${d.uuid}" target="_blank">Master Vault</a>
      </div>
    `;

    const houseContainer = document.createElement('div');
    houseContainer.style.display = 'flex';
    houseContainer.style.gap = '25px';
    houseContainer.style.flexWrap = 'wrap';
    houseContainer.style.justifyContent = 'center';

    Object.entries(d.cards).forEach(([house,cards])=>{
      const hLow = house.toLowerCase();

      const houseDiv = document.createElement('div');
      houseDiv.style.flex = '1 1 280px';
      houseDiv.style.minWidth = '240px';
      houseDiv.innerHTML = `
        <div class="house">
          <img src="icons/${hLow}.png" alt="${house}" onerror="this.src='icons/default.png'">
          <h3>${house}</h3>
        </div>
        <div class="house-cards">
          ${cards.length===0 ? '<div class="card">(no cards)</div>' : 
            cards.map(c=>`
              <div class="card">
                ${ERRATA[c] ? `<span class="errata">${c}</span><br><small>${ERRATA[c].replace(/\n/g,'<br>')}</small>` : c}
              </div>
            `).join('')
          }
        </div>
      `;
      houseContainer.appendChild(houseDiv);
    });

    div.appendChild(houseContainer);
    out.appendChild(div);
  });
}
</script>
</body>
</html>
