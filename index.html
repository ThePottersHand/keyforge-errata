<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KeyForge Errata Scanner</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="https://www.keyforgemastervault.com/favicon.ico">
  <meta name="theme-color" content="#111111">
  <style>
    :root { --bg: #111; --text: #eee; --accent: #0066cc; --errata: #ff4444; }
    * { box-sizing: border-box; }
    body { margin:0; padding:16px; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,sans-serif; }
    h1 { text-align:center; margin:0 0 8px; font-size:1.8em; }
    p { text-align:center; margin:8px 0 16px; color:#aaa; }
    
    /* FIX 1: Force video to be visible and full size */
    #scanner {
      width: 100% !important;
      max-width: 500px;
      height: 300px !important;
      margin: 16px auto;
      display: block;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      background: #000 !important;
      object-fit: cover;
    }

    button {
      width:100%; max-width:500px; margin:16px auto; display:block; padding:14px; font-size:18px;
      background:var(--accent); color:white; border:none; border-radius:12px; font-weight:600;
    }
    #deck { margin-top:24px; display:none; }
    .card { display:flex; align-items:center; padding:12px; border-bottom:1px solid #333; border-radius:8px; margin-bottom:8px; background:#1a1a1a; }
    .card img { width:60px; height:84px; margin-right:14px; border-radius:6px; object-fit:cover; }
    .card-title { font-weight:600; font-size:1.1em; }
    .card-house { font-size:0.85em; color:#999; margin-top:2px; }
    .errata { color:var(--errata); font-weight:bold; font-size:0.9em; margin-top:4px; }
    .errata-text { background:#300; padding:12px; border-radius:8px; margin:12px 0; font-size:0.95em; line-height:1.5; }
    .hidden { display:none; }
    .loading { text-align:center; color:#aaa; }
    #status { text-align:center; color:#aaa; margin:10px 0; font-weight:600; }
  </style>
</head>
<body>
  <h1>KeyForge Errata Scanner</h1>
  <p>Point your camera at any deck QR code</p>
  <div id="status">Tap below to start</div>
  
  <!-- FIX 2: Add visible container + force playsinline -->
  <div id="reader" style="width:100%; max-width:500px; margin:0 auto; border-radius:12px; overflow:hidden; box-shadow:0 4px 20px rgba(0,0,0,0.5); background:#000;"></div>
  
  <button onclick="startScanner()">Start Scanner</button>

  <div id="deck">
    <h2 id="deck-name" class="loading">Loading deck...</h2>
    <div id="cards"></div>
  </div>

  <!-- html5-qrcode -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <script>
    const deckDiv = document.getElementById('deck');
    const deckName = document.getElementById('deck-name');
    const cardsDiv = document.getElementById('cards');
    const status = document.getElementById('status');
    const readerDiv = document.getElementById('reader');
    let html5QrCode;

    const API_KEY = '6ec5419d-5b71-4598-aca5-a8a78eb51c82';

    const ERRATA = { /* ... same as before ... */ };

    function startScanner() {
      status.textContent = 'Requesting camera...';
      
      // FIX 3: Use div ID, not video element
      html5QrCode = new Html5Qrcode("reader");
      
      const config = {
        fps: 10,
        qrbox: { width: 250, height: 250 },
        aspectRatio: 1,
        // Force back camera + video constraints
        supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
      };

      html5QrCode.start(
        { facingMode: "environment" },
        config,
        (decodedText) => {
          const uuid = extractUuid(decodedText);
          if (uuid) {
            stopScanner();
            loadDeck(uuid);
          }
        },
        (error) => {
          console.warn('Scan frame error (normal):', error);
        }
      ).then(() => {
        status.textContent = 'Scanning... Point at QR code';
        document.querySelector('button').style.display = 'none';
      }).catch((err) => {
        status.textContent = `Error: ${err}`;
        console.error(err);
      });
    }

    function stopScanner() {
      if (html5QrCode) {
        html5QrCode.stop().then(() => {
          html5QrCode.clear();
          readerDiv.innerHTML = '';
        });
      }
      document.querySelector('button').style.display = 'block';
      status.textContent = 'Stopped.';
    }

    function extractUuid(text) {
      const urlMatch = text.match(/deck-details[\/.]([a-f0-9-]{36})/i);
      if (urlMatch) return urlMatch[1];
      const uuidMatch = text.match(/[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}/i);
      return uuidMatch ? uuidMatch[0] : null;
    }

    // ... rest of loadDeck() same as before ...

    async function loadDeck(uuid) {
      deckDiv.style.display = 'block';
      deckName.textContent = 'Loading...';
      cardsDiv.innerHTML = '<p class="loading">Fetching from Decks of KeyForge...</p>';

      try {
        const res = await fetch(`https://decksofkeyforge.com/public-api/v3/decks/${uuid}`, {
          headers: { 'Api-Key': API_KEY }
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        if (!data.deck?._links) throw new Error("Deck not found");

        deckName.textContent = data.deck.name || 'Unknown Deck';
        cardsDiv.innerHTML = '';

        data._linked.cards.forEach(card => {
          const div = document.createElement('div');
          div.className = 'card';
          const hasErrata = ERRATA[card.title];
          div.innerHTML = `
            <img src="${card.image_url}" alt="${card.title}" loading="lazy">
            <div>
              <div class="card-title">${card.title}</div>
              <div class="card-house">${card.house}</div>
              ${hasErrata ? '<div class="errata">ERRATA → Tap to view</div>' : ''}
            </div>
          `;
          if (hasErrata) {
            div.style.cursor = 'pointer';
            div.onclick = () => showErrata(card.title);
          }
          cardsDiv.appendChild(div);
        });

        localStorage.setItem('lastDeck', JSON.stringify({ uuid, data, time: Date.now() }));

      } catch (e) {
        deckName.textContent = 'Deck Not Found';
        cardsDiv.innerHTML = `
          <p style="color:#f88; text-align:center;">
            This deck isn't in DoK yet.<br><br>
            <strong>How to fix:</strong><br>
            1. Open in <strong>Master Vault</strong> app<br>
            2. Tap Share → "Open in DoK"<br>
            3. Try scanning again!
          </p>
        `;
      }
    }

    function showErrata(title) {
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;padding:20px;z-index:9999;';
      modal.innerHTML = `
        <div class="errata-text" style="max-width:500px;">
          <h3 style="margin-top:0;">${title} (Errata)</h3>
          <p>${ERRATA[title].replace(/⚡/g, 'Aember').replace(//g, 'Damage')}</p>
          <button onclick="this.closest('div').remove()" style="margin-top:16px;padding:10px 20px;background:#c00;color:white;border:none;border-radius:8px;">Close</button>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(console.error);
    }
  </script>
</body>
</html>
