<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KeyForge Errata Scanner</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="https://www.keyforgemastervault.com/favicon.ico">
  <meta name="theme-color" content="#111111">
  <style>
    :root { --bg: #111; --text: #eee; --accent: #0066cc; --errata: #ff4444; }
    * { box-sizing: border-box; }
    body { margin:0; padding:16px; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,sans-serif; }
    h1 { text-align:center; margin:0 0 8px; font-size:1.8em; }
    p { text-align:center; margin:8px 0 16px; color:#aaa; }
    #reader { width:100%; max-width:500px; margin:16px auto; height:300px; border-radius:12px; overflow:hidden; box-shadow:0 4px 20px rgba(0,0,0,0.5); background:#000; }
    button { width:100%; max-width:500px; margin:16px auto; display:block; padding:14px; font-size:18px; background:var(--accent); color:white; border:none; border-radius:12px; font-weight:600; }
    #deck { margin-top:24px; display:none; }
    .card { display:flex; align-items:center; padding:12px; border-bottom:1px solid #333; border-radius:8px; margin-bottom:8px; background:#1a1a1a; }
    .card img { width:60px; height:84px; margin-right:14px; border-radius:6px; object-fit:cover; }
    .card-title { font-weight:600; font-size:1.1em; }
    .card-house { font-size:0.85em; color:#999; margin-top:2px; }
    .errata { color:var(--errata); font-weight:bold; font-size:0.9em; margin-top:4px; }
    #status { text-align:center; color:#aaa; margin:10px 0; font-weight:600; }
    .tip { font-size:0.9em; color:#0cf; }
    .debug { margin-top:20px; padding:10px; background:#222; border-radius:8px; font-family:monospace; font-size:0.8em; max-height:100px; overflow:auto; }
  </style>
</head>
<body>
  <h1>KeyForge Errata Scanner</h1>
  <p>Point camera at the <strong>deck name</strong> (top of deck list card)</p>
  <p class="tip">Hold steady • Fill the frame • Good light</p>
  <div id="status">Tap to start</div>
  
  <div id="reader"></div>
  
  <button onclick="startScanner()">Start Scanner</button>

  <div id="deck">
    <h2 id="deck-name">Loading...</h2>
    <div id="cards"></div>
  </div>

  <!-- Optional: Debug OCR output -->
  <div id="debug" class="debug hidden"></div>

  <script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <script>
    const deckDiv = document.getElementById('deck');
    const deckName = document.getElementById('deck-name');
    const cardsDiv = document.getElementById('cards');
    const status = document.getElementById('status');
    const debug = document.getElementById('debug');
    let html5QrCode;
    let worker;
    let lastText = '';

    const API_KEY = '6ec5419d-5b71-4598-aca5-a8a78eb51c82';

    const ERRATA = { /* ... same as before ... */ };

    async function startScanner() {
      status.textContent = 'Initializing OCR...';
      debug.classList.add('hidden');
      debug.textContent = '';

      try {
        worker = await Tesseract.createWorker({
          logger: m => {
            if (m.status === 'recognizing text') {
              status.textContent = `OCR: ${(m.progress * 100).toFixed(0)}%`;
            }
          }
        });

        await worker.load();
        await worker.loadLanguage('eng');
        await worker.initialize('eng');

        // OPTIMIZED: Better for small, stylized text
        await worker.setParameters({
          tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789 ,-',
          preserve_interword_spaces: '1',
          tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK
        });

        status.textContent = 'Opening camera...';
        html5QrCode = new Html5Qrcode("reader");

        let frameCount = 0;
        html5QrCode.start(
          { facingMode: "environment" },
          { fps: 3 },  // Lower FPS = more stable OCR
          async () => {
            frameCount++;
            if (frameCount % 10 !== 0) return; // Only OCR every ~3 seconds

            const video = readerDiv.querySelector('video');
            if (!video) return;

            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            // PREPROCESS: Crop to top 30%, grayscale, upscale
            const cropHeight = canvas.height * 0.3;
            const cropped = ctx.getImageData(0, 0, canvas.width, cropHeight);
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width * 2;
            tempCanvas.height = cropHeight * 2;
            const tctx = tempCanvas.getContext('2d');
            tctx.imageSmoothingEnabled = false;
            tctx.drawImage(canvas, 0, 0, canvas.width, cropHeight, 0, 0, tempCanvas.width, tempCanvas.height);

            status.textContent = 'Reading text...';
            const result = await worker.recognize(tempCanvas);
            const text = result.data.text.trim();

            if (text && text.length > 5 && text !== lastText) {
              lastText = text;
              debug.textContent = `RAW: "${text}"`;
              debug.classList.remove('hidden');

              const cleanName = cleanDeckName(text);
              if (cleanName) {
                stopScanner();
                searchDeck(cleanName);
              }
            }
          },
          () => {}
        ).then(() => {
          status.textContent = 'Point at deck name • Hold steady';
          document.querySelector('button').style.display = 'none';
        });
      } catch (err) {
        status.textContent = `Error: ${err.message}`;
      }
    }

    function stopScanner() {
      if (html5QrCode) html5QrCode.stop();
      if (worker) worker.terminate();
      document.querySelector('button').style.display = 'block';
      status.textContent = 'Tap to scan again';
    }

    function cleanDeckName(text) {
      // Extract first meaningful line
      const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 5);
      if (!lines.length) return null;

      let name = lines[0];

      // Remove common noise
      name = name.replace(/KeyForge|Deck|Name|List|Archon|Æmber|Power|Tokens/gi, '');
      name = name.replace(/[^\w ,'-]/g, ' ').trim();
      name = name.replace(/\s+/g, ' ');

      // Must have at least one comma or be long
      if (name.includes(',') || name.length > 15) {
        return name;
      }
      return null;
    }

    async function searchDeck(name) {
      deckDiv.style.display = 'block';
      deckName.textContent = `Searching: "${name}"`;
      cardsDiv.innerHTML = '<p style="text-align:center;color:#aaa">Querying DoK...</p>';

      try {
        const res = await fetch(`https://decksofkeyforge.com/public-api/v3/decks/search?q=${encodeURIComponent(name)}`, {
          headers: { 'Api-Key': API_KEY }
        });
        const data = await res.json();

        const exactMatch = data.decks?.find(d => 
          d.name.toLowerCase() === name.toLowerCase()
        );

        if (exactMatch) {
          loadDeckByUuid(exactMatch.id, exactMatch.name);
        } else if (data.decks?.length > 0) {
          // Fallback: show first result
          const first = data.decks[0];
          deckName.textContent = `Found: "${first.name}" (tap to load)`;
          cardsDiv.innerHTML = `<p style="text-align:center"><button onclick="loadDeckByUuid('${first.id}', '${first.name}')" style="background:#0c6;padding:10px 20px;border:none;border-radius:8px;color:white;">Load This Deck</button></p>`;
        } else {
          throw new Error('No match');
        }
      } catch (e) {
        deckName.textContent = 'Not Found';
        cardsDiv.innerHTML = `
          <p style="color:#f88;text-align:center">
            No deck named "<strong>${name}</strong>" in DoK.<br><br>
            <a href="https://decksofkeyforge.com/decks/import" target="_blank" style="color:#0cf">Import to DoK</a> then try again.
          </p>
        `;
      }
    }

    window.loadDeckByUuid = async function(uuid, displayName) {
      deckName.textContent = 'Loading deck...';
      cardsDiv.innerHTML = '<p style="text-align:center;color:#aaa">Fetching cards...</p>';

      try {
        const res = await fetch(`https://decksofkeyforge.com/public-api/v3/decks/${uuid}`, {
          headers: { 'Api-Key': API_KEY }
        });
        const data = await res.json();

        deckName.textContent = displayName || data.deck.name;
        cardsDiv.innerHTML = '';

        data._linked.cards.forEach(card => {
          const div = document.createElement('div');
          div.className = 'card';
          const hasErrata = ERRATA[card.title];
          div.innerHTML = `
            <img src="${card.image_url}" alt="${card.title}" loading="lazy">
            <div>
              <div class="card-title">${card.title}</div>
              <div class="card-house">${card.house}</div>
              ${hasErrata ? '<div class="errata">ERRATA → Tap to view</div>' : ''}
            </div>
          `;
          if (hasErrata) {
            div.style.cursor = 'pointer';
            div.onclick = () => showErrata(card.title);
          }
          cardsDiv.appendChild(div);
        });
      } catch (e) {
        cardsDiv.innerHTML = '<p style="color:#f88">Failed to load deck.</p>';
      }
    };

    function showErrata(title) {
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;padding:20px;z-index:9999;';
      modal.innerHTML = `
        <div style="background:#300;padding:20px;border-radius:8px;max-width:500px;color:#eee;">
          <h3 style="margin-top:0;">${title} (Errata)</h3>
          <p>${ERRATA[title]}</p>
          <button onclick="this.closest('div').remove()" style="margin-top:16px;padding:10px 20px;background:#c00;color:white;border:none;border-radius:8px;">Close</button>
        </div>
      `;
      document.body.appendChild(modal);
    }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(() => {});
    }
  </script>
</body>
</html>
