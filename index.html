<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KeyForge Errata Scanner</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="data:,">
  <meta name="theme-color" content="#111111">
  <style>
    :root { --bg:#111; --txt:#eee; --acc:#0066cc; --err:#ff4444; }
    * { box-sizing:border-box; }
    body { margin:0; padding:16px; background:var(--bg); color:var(--txt); font-family:system-ui,-apple-system,sans-serif; }
    h1 { text-align:center; margin:0 0 8px; font-size:1.8em; }
    p { text-align:center; color:#aaa; margin:8px 0 16px; }
    input { width:100%; max-width:500px; margin:16px auto; display:block; padding:14px; font-size:18px; border:2px solid #444; border-radius:12px; background:#222; color:var(--txt); text-align:center; }
    input:focus { outline:none; border-color:var(--acc); }
    button { width:100%; max-width:500px; margin:16px auto; display:block; padding:14px; font-size:18px; background:var(--acc); color:white; border:none; border-radius:12px; font-weight:600; }
    .test-btn { background:#0c6; font-size:0.9em; padding:10px; margin-top:8px; }
    .suggestion { display:block; width:100%; max-width:500px; margin:8px auto; padding:12px; background:#333; border:none; border-radius:8px; color:var(--txt); cursor:pointer; text-align:left; }
    .suggestion:hover { background:#444; }
    #deck { margin-top:24px; display:none; }
    .card { display:flex; align-items:center; padding:12px; border-bottom:1px solid #333; border-radius:8px; margin-bottom:8px; background:#1a1a1a; }
    .card img { width:60px; height:84px; margin-right:14px; border-radius:6px; object-fit:cover; }
    .card-title { font-weight:600; font-size:1.1em; }
    .card-house { font-size:0.85em; color:#999; margin-top:2px; }
    .errata { color:var(--err); font-weight:bold; font-size:0.9em; margin-top:4px; }
    .loading { text-align:center; color:#aaa; }
    .notfound { color:#f88; text-align:center; }
    .import { color:#0cf; }
    #suggestions { max-height:200px; overflow:auto; }
    .error { color:#f88; font-size:0.9em; text-align:center; }
  </style>
</head>
<body>
  <h1>KeyForge Errata Scanner</h1>
  <p>Type deck name (partial works)</p>
  
  <input type="text" id="deckInput" placeholder="e.g. Grouseribius" autofocus>
  <button onclick="searchDeck()">Search Deck</button>
  <button class="test-btn" onclick="testKnownDeck()">Test Known Deck</button>

  <div id="suggestions"></div>

  <div id="deck">
    <h2 id="deck-name" class="loading">Searching...</h2>
    <div id="cards"></div>
  </div>

  <script>
    const API_KEY = '6ec5419d-5b71-4598-aca5-a8a78eb51c82';
    const PROXY = 'https://api.allorigins.win/raw?url=';  // CORS proxy
    const BASE = 'https://decksofkeyforge.com/public-api/v3/decks';

    const input = document.getElementById('deckInput');
    const suggestionsDiv = document.getElementById('suggestions');
    const deckDiv = document.getElementById('deck');
    const deckName = document.getElementById('deck-name');
    const cardsDiv = document.getElementById('cards');

    const ERRATA = {
      "Library Access": "Play: For the remainder of the turn, each time you play another card, draw a card. Purge Library Access."
      // ... your full list
    };

    let searchTimeout;
    input.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      const q = input.value.trim();
      suggestionsDiv.innerHTML = '';
      if (q.length < 3) return;
      searchTimeout = setTimeout(() => fetchSuggestions(q), 500);
    });

    input.addEventListener('keypress', e => { if (e.key === 'Enter') searchDeck(); });

    async function fetchSuggestions(query) {
      try {
        const url = `${PROXY}${encodeURIComponent(`${BASE}/search?q=${encodeURIComponent(query)}`)}`;
        const res = await fetch(url, { headers: { 'Api-Key': API_KEY } });
        if (!res.ok) throw new Error(`API ${res.status}`);
        const data = await res.json();
        suggestionsDiv.innerHTML = '';
        if (data.decks?.length) {
          data.decks.slice(0, 5).forEach(deck => {
            const btn = document.createElement('button');
            btn.className = 'suggestion';
            btn.innerHTML = `"${deck.name}"`;
            btn.onclick = () => loadDeck(deck.id, deck.name);
            suggestionsDiv.appendChild(btn);
          });
        }
      } catch (e) {
        suggestionsDiv.innerHTML = `<p class="error">Error: ${e.message}</p>`;
      }
    }

    async function searchDeck() {
      const name = input.value.trim();
      if (name.length < 3) return;

      deckDiv.style.display = 'block';
      deckName.textContent = `Searching: "${name}"`;
      cardsDiv.innerHTML = '<p class="loading">Querying DoK...</p>';
      suggestionsDiv.innerHTML = '';

      try {
        const url = `${PROXY}${encodeURIComponent(`${BASE}/search?q=${encodeURIComponent(name)}`)}`;
        const res = await fetch(url, { headers: { 'Api-Key': API_KEY } });
        if (!res.ok) throw new Error(`API ${res.status}`);
        const data = await res.json();

        const exact = data.decks?.find(d => d.name.toLowerCase() === name.toLowerCase());
        if (exact) {
          loadDeck(exact.id, exact.name);
        } else if (data.decks?.length) {
          deckName.textContent = 'Top results:';
          cardsDiv.innerHTML = '';
          data.decks.slice(0, 5).forEach(deck => {
            const div = document.createElement('div');
            div.className = 'suggestion';
            div.innerHTML = `<strong>"${deck.name}"</strong><br><button onclick="loadDeck('${deck.id}', '${deck.name}')" class="test-btn">Load</button>`;
            cardsDiv.appendChild(div);
          });
        } else {
          throw new Error('No results');
        }
      } catch (e) {
        deckName.textContent = 'Failed';
        cardsDiv.innerHTML = `<p class="notfound">Error: ${e.message}<br><br>Import to DoK first.</p>`;
      }
    }

    window.loadDeck = async function(uuid, displayName) {
      deckName.textContent = 'Loading...';
      cardsDiv.innerHTML = '<p class="loading">Fetching cards...</p>';

      try {
        const url = `${PROXY}${encodeURIComponent(`${BASE}/${uuid}`)}`;
        const res = await fetch(url, { headers: { 'Api-Key': API_KEY } });
        if (!res.ok) throw new Error(`Load failed: ${res.status}`);
        const data = await res.json();

        deckName.textContent = displayName;
        cardsDiv.innerHTML = '';

        data._linked.cards.forEach(card => {
          const div = document.createElement('div');
          div.className = 'card';
          const err = ERRATA[card.title];
          div.innerHTML = `<img src="${card.image_url}" loading="lazy"><div><div class="card-title">${card.title}</div><div class="card-house">${card.house}</div>${err?'<div class="errata">ERRATA</div>':''}</div>`;
          if (err) div.onclick = () => alert(`${card.title}\n\n${ERRATA[card.title]}`);
          cardsDiv.appendChild(div);
        });
      } catch (e) {
        cardsDiv.innerHTML = `<p class="notfound">Load error: ${e.message}</p>`;
      }
    };

    function testKnownDeck() {
      input.value = 'Grouseribius';
      searchDeck();
    }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(() => {});
    }
  </script>
</body>
</html>
