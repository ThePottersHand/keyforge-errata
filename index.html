<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KeyForge Errata Scanner [DEBUG]</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="https://www.keyforgemastervault.com/favicon.ico">
  <meta name="theme-color" content="#111111">
  <style>
    :root { --bg: #111; --text: #eee; --accent: #0066cc; --errata: #ff4444; }
    * { box-sizing: border-box; }
    body { margin:0; padding:16px; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,sans-serif; }
    h1 { text-align:center; margin:0 0 8px; font-size:1.8em; }
    p { text-align:center; margin:8px 0 16px; color:#aaa; }
    #reader { width:100%; max-width:500px; margin:16px auto; height:300px; border-radius:12px; overflow:hidden; box-shadow:0 4px 20px rgba(0,0,0,0.5); background:#000; }
    button { width:100%; max-width:500px; margin:16px auto; display:block; padding:14px; font-size:18px; background:var(--accent); color:white; border:none; border-radius:12px; font-weight:600; }
    #deck { margin-top:24px; display:none; }
    .card { display:flex; align-items:center; padding:12px; border-bottom:1px solid #333; border-radius:8px; margin-bottom:8px; background:#1a1a1a; }
    .card img { width:60px; height:84px; margin-right:14px; border-radius:6px; object-fit:cover; }
    .card-title { font-weight:600; font-size:1.1em; }
    .card-house { font-size:0.85em; color:#999; margin-top:2px; }
    .errata { color:var(--errata); font-weight:bold; font-size:0.9em; margin-top:4px; }
    #status { text-align:center; color:#0cf; margin:10px 0; font-weight:600; }
    .debug { margin-top:20px; padding:12px; background:#222; border-radius:8px; font-family:monospace; font-size:0.85em; max-height:200px; overflow:auto; border:1px solid #444; }
    .debug img { max-width:100%; margin-top:8px; border-radius:6px; }
    .tip { font-size:0.9em; color:#0cf; }
  </style>
</head>
<body>
  <h1>KeyForge Errata Scanner</h1>
  <p>Point at <strong>deck name</strong> (top of card)</p>
  <p class="tip">Hold steady • Fill top of screen • Bright light</p>
  <div id="status">Tap to start</div>
  
  <div id="reader"></div>
  
  <button onclick="startScanner()">Start Scanner</button>

  <!-- DEBUG PANEL -->
  <div id="debug" class="debug">
    <strong>OCR Debug Log</strong><br>
    <span id="log"></span>
    <div id="snapshot"></div>
  </div>

  <div id="deck">
    <h2 id="deck-name">Loading...</h2>
    <div id="cards"></div>
  </div>

  <script src="https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <script>
    const status = document.getElementById('status');
    const log = document.getElementById('log');
    const snapshot = document.getElementById('snapshot');
    const deckDiv = document.getElementById('deck');
    const deckName = document.getElementById('deck-name');
    const cardsDiv = document.getElementById('cards');
    let html5QrCode;
    let worker;
    let lastOcrTime = 0;

    const API_KEY = '6ec5419d-5b71-4598-aca5-a8a78eb51c82';

    const ERRATA = {
      "Arcenomometer": "Enhance two. Action: During your opponent’s next turn, each time they play a card, they lose 1 Aember.",
      "Yzphyz Knowdrone": "Play: Archive a card. You may purge an archived card. If you do, stun a creature."
      // ... (keep your full list)
    };

    function logDebug(msg, imgData = null) {
      const time = new Date().toLocaleTimeString();
      log.innerHTML += `<br>[${time}] ${msg}`;
      log.scrollTop = log.scrollHeight;
      if (imgData) {
        const img = document.createElement('img');
        img.src = imgData;
        snapshot.innerHTML = '';
        snapshot.appendChild(img);
      }
    }

    async function startScanner() {
      logDebug('Initializing Tesseract...');
      status.textContent = 'Initializing OCR...';

      try {
        worker = await Tesseract.createWorker({
          logger: m => {
            if (m.status === 'recognizing text') {
              status.textContent = `OCR: ${(m.progress * 100).toFixed(0)}%`;
            }
          }
        });
        await worker.load();
        await worker.loadLanguage('eng');
        await worker.initialize('eng');
        await worker.setParameters({
          tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789 ,-\'',
          preserve_interword_spaces: '1',
          tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK
        });

        logDebug('Tesseract ready');

        status.textContent = 'Opening camera...';
        html5QrCode = new Html5Qrcode("reader");

        html5QrCode.start(
          { facingMode: "environment" },
          { fps: 5 },
          async () => {
            const now = Date.now();
            if (now - lastOcrTime < 2000) return; // OCR every 2 sec
            lastOcrTime = now;

            const video = document.querySelector('#reader video');
            if (!video || video.videoWidth === 0) return;

            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            // Crop top 30%
            const cropH = canvas.height * 0.3;
            const cropped = ctx.getImageData(0, 0, canvas.width, cropH);

            // Upscale 2x
            const upscaled = document.createElement('canvas');
            upscaled.width = canvas.width * 2;
            upscaled.height = cropH * 2;
            const uctx = upscaled.getContext('2d');
            uctx.imageSmoothingEnabled = false;
            uctx.drawImage(canvas, 0, 0, canvas.width, cropH, 0, 0, upscaled.width, upscaled.height);

            const imgDataUrl = upscaled.toDataURL();

            logDebug('Running OCR on cropped image...', imgDataUrl);
            status.textContent = 'Reading text...';

            const result = await worker.recognize(upscaled);
            const text = result.data.text;

            logDebug(`RAW OCR: "${text}"`);

            const name = cleanDeckName(text);
            if (name) {
              logDebug(`CLEAN NAME: "${name}" → Searching DoK...`);
              stopScanner();
              searchDeck(name);
            } else {
              logDebug('No valid name found. Keep scanning...');
            }
          },
          () => {}
        ).then(() => {
          status.textContent = 'Scanning... (OCR every 2 sec)';
          document.querySelector('button').style.display = 'none';
        });
      } catch (err) {
        logDebug(`ERROR: ${err.message}`);
        status.textContent = 'OCR failed. Check console.';
      }
    }

    function stopScanner() {
      if (html5QrCode) html5QrCode.stop();
      if (worker) worker.terminate();
      document.querySelector('button').style.display = 'block';
      status.textContent = 'Stopped. Tap to restart.';
    }

    function cleanDeckName(text) {
      const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 3);
      if (!lines.length) return null;
      let name = lines[0];
      name = name.replace(/KeyForge|Deck|Name|Archon|Æmber/gi, '').trim();
      name = name.replace(/[^\w ,'-]/g, ' ').replace(/\s+/g, ' ').trim();
      return (name.includes(',') || name.length > 12) ? name : null;
    }

    async function searchDeck(name) {
      deckDiv.style.display = 'block';
      deckName.textContent = `Searching: "${name}"`;
      cardsDiv.innerHTML = '<p style="text-align:center;color:#aaa">Querying DoK...</p>';

      try {
        const res = await fetch(`https://decksofkeyforge.com/public-api/v3/decks/search?q=${encodeURIComponent(name)}`, {
          headers: { 'Api-Key': API_KEY }
        });
        const data = await res.json();

        const exact = data.decks?.find(d => d.name.toLowerCase() === name.toLowerCase());
        if (exact) {
          loadDeckByUuid(exact.id, exact.name);
        } else if (data.decks?.length) {
          const first = data.decks[0];
          deckName.textContent = `Found: "${first.name}"`;
          cardsDiv.innerHTML = `<p style="text-align:center"><button onclick="loadDeckByUuid('${first.id}', '${first.name}')" style="background:#0c6;padding:10px 20px;border:none;border-radius:8px;color:white;">Load This</button></p>`;
        } else {
          throw new Error();
        }
      } catch {
        deckName.textContent = 'Not in DoK';
        cardsDiv.innerHTML = `<p style="color:#f88;text-align:center">"<strong>${name}</strong>" not found.<br><a href="https://decksofkeyforge.com/decks/import" target="_blank" style="color:#0cf">Import to DoK</a></p>`;
      }
    }

    window.loadDeckByUuid = async function(uuid, name) {
      // ... same as before (render deck)
      deckName.textContent = 'Loading cards...';
      const res = await fetch(`https://decksofkeyforge.com/public-api/v3/decks/${uuid}`, { headers: { 'Api-Key': API_KEY } });
      const data = await res.json();
      deckName.textContent = name;
      cardsDiv.innerHTML = '';
      data._linked.cards.forEach(card => {
        const div = document.createElement('div');
        div.className = 'card';
        const hasErrata = ERRATA[card.title];
        div.innerHTML = `<img src="${card.image_url}" loading="lazy"><div><div class="card-title">${card.title}</div><div class="card-house">${card.house}</div>${hasErrata ? '<div class="errata">ERRATA → Tap</div>' : ''}</div>`;
        if (hasErrata) div.onclick = () => alert(`${card.title}\n\n${ERRATA[card.title]}`);
        cardsDiv.appendChild(div);
      });
    };

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(() => {});
    }
  </script>
</body>
</html>
